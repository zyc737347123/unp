# TCP/UDP/IP学习笔记

##TCP

###0. TCP的三次握手和四次挥手

所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。

三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。在 socket 编程中，客户端执行 `connect()` 时。将触发三次握手。

- 服务器端套接字（socket）经过socket，bind，listen三个函数调用，处于`LISTEN`状态

- 第一次握手(SYN=1, seq=x):

  客户端调用connect（堵塞）

  客户端发送一个 TCP 的 SYN 标志位置1的包，指明客户端打算连接的服务器的端口，以及初始序号 X,保存在包头的序列号(Sequence Number)字段里。

  发送完毕后，客户端进入 `SYN_SEND` 状态。

- 第二次握手(SYN=1, ACK=1, seq=y, ACKnum=x+1):

  服务器调用accept（堵塞）

  服务器发回确认包(ACK)应答。即 SYN 标志位和 ACK 标志位均为1。服务器端选择自己 ISN 序列号，放到 Seq 域里，同时将确认序号(Acknowledgement Number)设置为客户的 ISN 加1，即X+1。 发送完毕后，服务器端进入 `SYN_RCVD` 状态。

  收到这个从服务器ACK，客户端connect调用返回，客户端此时状态已经进入`ESTABLISHED`

- 第三次握手(ACK=1，ACKnum=y+1)

  服务器accept调用返回

  客户端再次发送确认包(ACK)，SYN 标志位为0，ACK 标志位为1，并且把服务器发来 ACK 的序号字段+1，放在确定字段中发送给对方，并且在数据段放写ISN的+1
  
  发送完毕后，客户端进入 `ESTABLISHED` 状态，当服务器端接收到这个包时，也进入 `ESTABLISHED`状态，TCP 握手结束。

TCP的三次握手图示：
![](https://raw.githubusercontent.com/HIT-Alibaba/interview/master/img/tcp-connection-made-three-way-handshake.png)

1. 在三次握手的时候，SYN（同步分节）可以带上什么信息

   首先SYN会告知对端本端选择的Sequence Number的初始值，Sequence Number用于在TCP连接中进行数据包的排序和确认等等作用，**Sequence Number**是包的序号，**用来解决网络包乱序（reordering）问题**，每次建立TCP连接，每端都出随机初始化本端的Sequence Number，并使用SYN告知对端；

   同时每一个SYN都可以含有多个TCP选项：

   - MSS选项：本端用于告知对端，本端可接受的最大分节大小（max segment size）
   - 窗口规模选项：TCP报文头的窗口只有16bit，所以滑动窗口的最大窗口大小为65535；这个选项用于指定TCP报文头中的窗口大小左移位数，用于扩大窗口大小，最大可达1GB（65535 * 2^14）
   - 时间戳选项：防止由于失而复得的分组可能造成的数据损毁

2. 如果机器上出现很多SYN_SEND状态的连接

   如果出现很多SYN_SEND，那一般有这么几种情况：

   - 是你要访问的网站不存在或线路不好
   - 是用扫描软件扫描一个网段的机器，也会出出现很多SYN_SENT，另外就是可能中了病毒了，例如中了"冲击波"，病毒发作时会扫描其它机器，这样会有很多SYN_SENT出现

3. 如果机器上出现很多SYN_RCVD状态的连接

   正常情况下SYN_RCVD状态非常短暂。如果发现有很多SYN_RCVD状态，那你的机器有可能被**SYN Flood**的DoS(拒绝服务攻击)攻击了

   在进行三次握手时，攻击软件向被攻击的服务器发送SYN连接请求(握手的第一步)，但是这个地址是伪造的，如攻击软件随机伪造了51.133.163.104、65.158.99.152等等地址。 服务器 在收到连接请求时将标志位 ACK和 SYN 置1发送给客户端(握手的第二步)，但是这些客户端的IP地址都是伪造的，服务器根本找不到客户机，也就是说握手的第三步不可能完成
   
   这种情况下服务器端一般会重试(再次发送SYN+ACK给客户端)并等待一段时间后丢弃这个未完成的连接，这段时间的长度我们称为**SYN Timeout**，一般来说这个时间是分钟的数量级(大约为30秒-2分钟);一个用户出现异常导致服务器的一个线程等待1分钟并不是什么很大的问题，但如果有一个恶意的攻击者大量模拟这种情况，服务器端将为了维护一个非常大的半连接列表而消耗非常多的资源，比如数以万计的半连接，即使是简单的保存并遍历也会消耗非常多的 CPU 时间和内存，何况还要不断对这个列表中的IP进行SYN+ACK的重试。此时从正常客户的角度看来，服务器失去响应，这种情况我们称做： 服务器端受到了**SYN Flood攻击(SYN洪水攻击 )**

