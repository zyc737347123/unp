# 网络知识学习笔记

## 0. 知识点

- 交换机是工作在数据链路层的，所以又叫二层设备
- **交换机学习“源地址”，基于“目的地址”转发**
- **交换机泛洪**：如果没有在表中找到目的MAC地址，**交换机**会转发到除了进入端口以外的所有端口**泛洪**（flooding）。有多个互连交换机的网络中，MAC地址表对于一个连接至其他交换机的端口记录多个MAC地址
- **冲突域**：设备间共享同一网段称为冲突域。因为该网段内两个以上设备同时尝试通讯时，可能发生冲突。使用工作在数据链路层的交换机可将各个网段的冲突域隔离，并减少竞争带宽的设备数量。**交换机**的每一个端口就是一个新的网段，因为插入端口的设备之间无需竞争。结果是每一个端口都代表一个新的冲突域。网段上的设备可以使用更多带宽，冲突域内的冲突不会影响到其他网段，这也成为**微网段**
- **广播域**：尽管**交换机**按照MAC地址过滤大多数帧，它们并不能过滤广播帧。LAN上的交换机接收到广播包后，必须对所有端口**泛洪**。互连的交换机集合形成了一个广播域。网络层设备如路由器，可隔离二层广播域。路由器可同时隔离冲突和广播域；当设备发出二层广播包，帧中的目的MAC地址被设置为全二进制数，广播域中的所有设备都会接收到该帧。二层广播域也称为MAC广播域。MAC广播域包含LAN上所有接收到广播帧的设备。广播通信比较多时，可能会带来**广播风暴**。特别是在包含不同速率的网段，高速网段产生的广播流量可能导致低速网段严重拥挤，乃至崩溃
- **以太网交换机**工作在第二层即数据链路层，用于在同一网络内部转发以太网帧

##  1. Web协议概览
### 一个经典例子

用一个下单的过程，看看互联网世界的运行过程中，都使用了哪些网络协议

1. 首先输入**URL**，此时需要用到**DNS**将网址转换为服务器的**IP**

2. 浏览器使用**HTTP**（应用层）协议描述请求
    ![](https://static001.geekbang.org/resource/image/d8/c6/d8a65ca347ad26acc9f1de49b10320c6.png)

3. 经过应用层封装后，浏览器会将应用层的包交给下一层去完成，通过socket 编程来实现。下一层是传输层。传输层有两种协议，一种是无连接的协议**UDP**，一种是面向连接的协议**TCP**
    ![](https://static001.geekbang.org/resource/image/53/ee/53c753a7d49c9dfe3cfeb26497e47eee.png)

4. 传输层封装完毕后，浏览器会将包交给操作系统的网络层。网络层的协议是 **IP** 协议
    ![](https://static001.geekbang.org/resource/image/45/1b/459a421975b27f6187d2aa4673171f1b.png)

5. OS知道了服务器IP不在一个网段(通过子网掩码计算，目标IP是否在同一网段)，会将数据包发到网关（路由器），网关IP一般是OS启动的时候被**DHCP**服务器告知网关IP。本地通信需要通过MAC地址完成，OS为了将数据包发给网关，会使用**ARP**协议获得网关MAC地址。于是OS将IP包交给下层（MAC层/链路层），网卡再将包发出去。由于这个包里面是有 MAC 地址的，因而它能够到达网关
![](https://static001.geekbang.org/resource/image/cc/4f/cc02190ac57af7fb6c3839534f2b674f.png)

6. 网关（一般是路由器）收到包以后，根据路由表判断目标IP的转发路径。路由是边关，连接着两个国家（局域网），每个局域网内的设备都可以使用MAC地址通信
![](https://static001.geekbang.org/resource/image/f7/e2/f7ea602aec91c67b35e710fb72a975e2.png)
路由器往往是知道这些“路径”，因为路由器之间会经常沟通，确定两个IP间的最佳“路径”，这种的协议就是**路由协议**，常用的有**OSPF**和**BGP**
![](https://static001.geekbang.org/resource/image/b2/d4/b25ad7afba7b79331d95875dd0f451d4.png)

7. 最好到达目标机器后，目标机器的OS和应用会将数据包逐层拆开，在确认无误后，将上层数据包继续传递，可以用下图概括
![](https://static001.geekbang.org/resource/image/b4/3f/b465ccfafe333bfdfb9daf78f96e123f.png)

## 2. 网络分层

1. **网络分层**是为了明确职责，网络每层协议负责的工作不一样，对应的硬件设备往往也不一样（交换机，路由器，PC/服务器），如果网络只有一层，网络上所以节点都处于同一层，必然会造成混乱
2. 逐层处理的逻辑过程如下：
![](https://static001.geekbang.org/resource/image/06/ea/06b355394f525c54f200d8a1af63ddea.jpg)